<?php
namespace App\Models\Billing;


// use App\Models\Billing\BillingItemsForJson;
// use App\Models\Billing\BillingItemObjToAssocArray as BItem;
use App\Models\Billing\BillingItem;
use App\Models\Billing\Cobranca;
use App\Models\Billing\CobrancaTipo;
// use App\Models\Billing\RefForBillingItem as Ref;
use App\Models\Finance\BankAccount;
use App\Models\Immeubles\Contract;
use App\Models\Immeubles\CondominioTarifa;
use App\Models\Tributos\IPTUTabela;
use App\Models\Utils\DateFunctions;
use App\User;
use Carbon\Carbon;

class CobrancaGerador {

  private $cobranca         = null;
  private $contract         = null;
  private $monthyeardateref = null;
  private $cobranca_gerada  = false;
  private $cobranca_dbsaved = true;

  public function __construct(
                      $contract,
                      $monthyeardateref = null,
                      $create_new_if_exists=false ) {

    if ($contract == null) {
      $error = 'Contract object is null when instanting a CobrancaGerador object.';
      throw new Exception($error);
    }
    $this->contract = $contract;
    // next method will also treat null $monthyeardateref
    $this->set_monthly_duedate_based_on_monthyeardateref();

    // instantiate an emtpy Cobranca, if $create_new_if_exists=false, try to fetch an existing one
    $this->cobranca = new Cobranca;
    if ($create_new_if_exists=false) {
      $this->db_fetch_cobranca_to_obj_if_exists();
    }
    $this->cobranca_gerada  = false;
    $this->cobranca_dbsaved = false;

  } // ends __construct()

  public function get_cobranca() {
    return $this->cobranca;
  }

  private function db_fetch_cobranca_to_obj_if_exists() {
    $cobranca = Cobranca::where('contract_id', $contract->id)
      ->where('monthyeardateref', $monthyeardateref)
      ->first();
    if ($cobranca != null) {
      $this->cobranca = $cobranca;
    }
  }

  public function set_monthyeardateref_relative_to_today() {
    $this->monthyeardateref = DateFunctions
      ::find_rent_monthyeardateref_under_convention(
        Carbon::today(),
        $this->contract->pay_day_when_monthly
      );
  }

  public function set_monthly_duedate_based_on_monthyeardateref() {
    if ($this->monthyeardateref==null) {
      $this->set_monthyeardateref_relative_to_today();
    }
    $this->monthly_duedate  = $this->monthyeardateref->copy()->addMonths(1);
    $this->monthly_duedate->day = $this->contract->pay_day_when_monthly;
  }

  private function create_billingitem_aluguel() {
    $billingitem  = new BItem;
    $assoc_array  = array();
    $cobrancatipo = CobrancaTipo
      ::where('char_id', CobrancaTipo::K_TEXT_ID_ALUGUEL)
      ->first();
    $billingitem->cobrancatipo_id = $cobrancatipo->id;
    $billingitem->brief_description = $cobrancatipo->brief_description;
    // fetch value
    $billingitem->item_value = $this->contract->current_rent_value;
    $is_yearly=false;
    $billingitem->ref_obj = Ref::make_ref_obj_with_date($this->monthyeardateref, $is_yearly);
    return $billingitem;
  }

  private function create_billingitem_iptu($iptu_table) {
    $billingitem  = new BItem;
    $cobrancatipo = CobrancaTipo
      ::where('char_id', CobrancaTipo::K_TEXT_ID_IPTU)
      ->first();
    $billingitem->cobrancatipo_id = $cobrancatipo->id;;
    $billingitem->brief_description = $cobrancatipo->brief_description;
    // 1st case: IPTU for year has been fully paid
    if ($iptu_table->ano_quitado == true) {
      return null;
    }
    // 2nd case: cota-única anual a ser repassada em Fevereiro, ref. Janeiro
    if ($iptu_table->optado_por_cota_unica == true && $this->monthyeardateref->month == 1) {
      $billingitem->item_value = $iptu_table->valor_parcela_unica;
      $n_cota_ref      = 1;
      $total_cotas_ref = 1;
      $is_yearly       = true;
      $billingitem->ref_obj = Ref::make_ref_obj_with_parcels($n_cota_ref, $total_cotas_ref, $is_yearly);
      return $billingitem;
    }
    // 3rd case: cota-única anual a ser repassada em Fevereiro, ref. Janeiro
    if ($this->monthyeardateref->month == 1 || $this->monthyeardateref->month == 12) {
      // this case is optado por 10x and the first one starts in March ref. February
      // Billing happens from March to December, ref. Feb to Nov
      return null;
    }
    $billingitem->item_value = $iptu_table->valor_parcela_10x;
    $n_cota_ref              = $this->monthyeardateref->month - 1; // ie, the February bill is the 1st parcel
    $total_cotas_ref         = IPTUTabela::K_IPTU_TOTAL_COTAS;
    $billingitem->ref_obj    = Ref::make_ref_obj_with_parcels($n_cota_ref, $total_cotas_ref);
    return $billingitem;
  }

  private function create_billingitem_condominio() {
    if ($this->contract->imovel == null) {
      $error = '[In CobrancaGerador::create_billingitem_condominio()] Contract object does not have an imovel object attached to it.';
      throw new Exception($error);
    }
    $billingitem     = new BItem();
    $cobrancatipo = CobrancaTipo
      ::where('char_id', CobrancaTipo::K_TEXT_ID_CONDOMINIO)
      ->first();
    $billingitem->cobrancatipo_id = $cobrancatipo->id;
    $billingitem->brief_description = $cobrancatipo->brief_description;
    // fetch value
    $condominio_tarifa = CondominioTarifa
      ::where('imovel_id', $this->contract->imovel->id)
      ->where('monthyeardateref', $this->monthyeardateref)
      ->first();
    $brief_info = null;
    if ($condominio_tarifa == null) {
      $condominio_valor = CondominioTarifa::calcular_media_das_ultimas_tarifas();
      $brief_info = 'Usado Média';
    } else {
      $condominio_valor = $condominio_tarifa->tarifa_valor;
    }
    $billingitem->item_value = $condominio_valor;
    $is_yearly=false;
    $billingitem->ref_obj = Ref::make_ref_obj_with_date($this->monthyeardateref, $is_yearly);
    if ($brief_info != null) {
      $billingitem->ref_obj->brief_info = $brief_info;
    }
    return $billingitem;
  }

  public function gerar_cobranca_based_on_today($regerar=false) {
    if ($this->cobranca_gerada == true && $regerar==false) {
      return;
    };
    $this->set_monthyeardateref_relative_to_today();
    $this->set_monthly_duedate_based_on_monthyeardateref();
    return $this->gerar();
  }

  public function gerar_cobranca_based_on_especified_date($monthyeardateref, $regerar=false) {
    if ($this->cobranca_gerada == true && $regerar==false) {
      return;
    };
    $this->set_monthly_duedate_based_on_monthyeardateref();
    return $this->gerar();
  }

  private function gerar() {
    /*
    DO NOT run $this->set_obj_dates_based_on_today() in here!!!
    */

    $billingitems = new BillingItemsForJson;

    // The first item in 'cobrança' is the rent itself
    // [1] Add Aluguel
    $billingitem = $this->create_billingitem_aluguel();
    $billingitems->add($billingitem);
    // [2] Add IPTU if applicable
    if ($this->contract->repassar_iptu) {
      // imovel is protected against null in Constructor (ie, $this->contract->imovel is not null at this point)
      $iptutabela = IPTUTabela
        ::where('imovel_id', $this->contract->imovel->id)
        ->where('ano', $this->monthyeardateref->year)
        ->first();
      if ($iptutabela == null) {
        return null;
      }
      if ($iptutabela->ano_quitado == true) {
        return null;
      }
      $billingitem = $this->create_billingitem_iptu($iptutabela);
      if ($billingitem != null) {
        $billingitems->add($billingitem);
      }
    }
    // [3] Add Condominio if applicable
    if ($this->contract->repassar_condominio) {
      $billingitem = $this->create_billingitem_condominio();
      if ($billingitem != null) {
        $billingitems->add($billingitem);
      }
    }

    $cobranca_total = $billingitems->get_total();

    $this->cobranca->monthyeardateref   = $this->monthyeardateref;
    $this->cobranca->duedate            = $this->monthly_duedate;
    $this->cobranca->billingitemsinjson = $billingitems->get_json();
    $this->cobranca->total              = $cobranca_total;
    $this->cobranca->contract_id        = $this->contract->id;
    $this->cobranca->bankaccount_id     = $this->contract->bankaccount_id;

    $this->cobranca_gerada = true;
  } // ends gerar_cobranca()

  public function save_cobranca() {
    if ($this->cobranca_dbsaved == true) {
      return null;
    }
    if ($this->cobranca_gerada == true) {
      $this->cobranca->save();
      $this->cobranca_dbsaved = true;
      return true;
    }
    return false;
  }

  public function __toString() {
    $outstr = 'Gerador\n ';
    $outstr .= $this->cobranca->__toString();
    return $outstr;
  }


}
